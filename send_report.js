import nodemailer from "nodemailer";
import fs from "fs";
import path from "path";

// Gmail credentials
const user = process.env.GMAIL_USER;
const pass = process.env.GMAIL_PASS;

// Suite + status
const suite = process.env.TEST_SUITE || "all";
const testStatus = process.env.TEST_STATUS || "Failed";
const subject = `Playwright CI Report - ${suite} (${testStatus})`;

// Paths
const reportPath = path.resolve("playwright-report/index.html");
const reportUrl = process.env.REPORT_URL || null;

const pipelineName = process.env.PIPELINE_NAME || "QA Automation Pipeline";
const environment = process.env.ENVIRONMENT || "Production";
const duration = process.env.TEST_DURATION || "3m 42s";

// Check if local report exists
let reportExists = false;
try {
  await fs.promises.access(reportPath);
  reportExists = true;
  console.log("‚úÖ Found Playwright HTML report:", reportPath);
} catch {
  console.warn("‚ö†Ô∏è Report not found at:", reportPath);
}

// Configure Gmail SMTP
const transporter = nodemailer.createTransport({
  service: "gmail",
  auth: { user, pass },
});

// --- üßæ Build clean professional HTML email ---
let emailBody = `
  <div style="font-family: Arial, sans-serif; color: #222; background:#f8f9fa; padding:20px;">
    <div style="background:#fff; border-radius:8px; padding:20px; border:1px solid #ddd; max-width:600px; margin:auto;">

      <h2 style="color:#111; margin:0; font-size:22px;">Playwright CI Test Report</h2>
      <p style="margin:4px 0 12px 0; font-size:13px; color:#555;">
        Automated report generated by <b>${pipelineName}</b>
      </p>

      <table style="width:100%; font-size:13px; border-collapse:collapse; margin-bottom:16px;">
        <tr><td style="width:140px;"><b>Suite:</b></td><td>${suite}</td></tr>
        <tr><td><b>Status:</b></td><td style="color:${testStatus === "Passed" ? "green" : "red"};">${testStatus}</td></tr>
        <tr><td><b>Environment:</b></td><td>${environment}</td></tr>
        <tr><td><b>Duration:</b></td><td>${duration}</td></tr>
        <tr><td><b>Timestamp:</b></td><td>${new Date().toLocaleString()}</td></tr>
      </table>
`;

// Add report link (black button)
if (reportUrl) {
  emailBody += `
      <p>
        <a href="${reportUrl}" target="_blank" rel="noopener noreferrer"
           style="display:inline-block;background:#000;color:#fff;
                  padding:12px 18px;font-weight:bold;border-radius:6px;
                  text-decoration:none;font-size:14px;">
          View Full HTML Report
        </a>
      </p>

      <p style="font-size:12px;color:#555;margin-top:8px;">
        Or copy and paste this link:<br>
        <a href="${reportUrl}" target="_blank" style="color:#000;">${reportUrl}</a>
      </p>
  `;
} else {
  emailBody += `
      <p style="color:#a94442;">Report link unavailable ‚Äî check S3 or Jenkins configuration.</p>
  `;
}

// Add footer note about attachment
if (reportExists) {
  emailBody += `
      <div style="margin-top:15px; background:#f4f4f4; padding:10px 12px; border-left:4px solid #333;">
        The Playwright HTML report is also attached below for offline viewing.
      </div>
  `;
} else {
  emailBody += `
      <div style="margin-top:15px; background:#fff3cd; padding:10px 12px; border-left:4px solid #999;">
        Local report not found; please use the online report link.
      </div>
  `;
}

emailBody += `
      <hr style="border:none;border-top:1px solid #ddd;margin:20px 0;">
      <p style="font-size:12px;color:#777;">
        Sent automatically by <b>Playwright CI</b> ‚Äî do not reply to this email.
      </p>

    </div>
  </div>
`;

// --- ‚úâÔ∏è Compose and send ---
const mailOptions = {
  from: `"Playwright CI" <ci-reports@automation.com>`,
  to: ["gopalakrishnan93843@gmail.com", "gokulcoal78752@gmail.com"],
  cc: ["gokulgokul78752@gmail.com"],
  bcc: ["gokulakrishnan1607@gmail.com"],
  subject,
  html: emailBody,
};

// Attach the HTML report if exists
if (reportExists) {
  mailOptions.attachments = [
    {
      filename: "playwright-report.html",
      path: reportPath,
      contentType: "text/html",
    },
  ];
}

// --- Send email ---
try {
  await transporter.sendMail(mailOptions);
  console.log("‚úÖ Email sent successfully with report!");
} catch (err) {
  console.error("‚ùå Failed to send email:", err.message);
  process.exit(1);
}

