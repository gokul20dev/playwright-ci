// send_report.js
import nodemailer from "nodemailer";
import fs from "fs";
import path from "path";

(async () => {
  try {
    const user = process.env.GMAIL_USER;
    const pass = process.env.GMAIL_PASS;

    if (!user || !pass) {
      console.error("‚ùå GMAIL_USER or GMAIL_PASS not set in environment");
      process.exit(1);
    }

    const suite = process.env.TEST_SUITE || "all";
    const testStatus = process.env.TEST_STATUS || "Failed";
    const reportUrl = process.env.REPORT_URL || null;
    const pipelineName = process.env.PIPELINE_NAME || "QA Automation Pipeline";
    const duration = process.env.TEST_DURATION || "-";

    // --- find HTML report ---
    function findHtmlReport(dir = "playwright-report") {
      if (!fs.existsSync(dir)) return null;
      const entries = fs.readdirSync(dir, { withFileTypes: true });
      for (const e of entries) {
        const full = path.join(dir, e.name);
        if (e.isFile() && (e.name === "index.html" || e.name === "report.html"))
          return full;
        if (e.isDirectory()) {
          const found = findHtmlReport(full);
          if (found) return found;
        }
      }
      return null;
    }

    const reportPath = findHtmlReport();
    const reportExists = !!reportPath;

    if (reportExists) {
      console.log("‚úÖ Found HTML report:", reportPath);
    } else {
      console.warn("‚ö†Ô∏è No HTML report found; attaching fallback if available.");
    }

    // --- Build email HTML (button moved below timestamp) ---
    const emailBody = `
      <div style="font-family:Arial, sans-serif; background:#eef3fc; padding:14px;">
        <div style="background:#fff; padding:14px; border-radius:6px; border:1px solid #c5d3f2; max-width:640px;">
          
          <h2 style="margin:0 0 10px 0;">Playwright CI Test Report</h2>
          
          <p style="margin:6px 0; font-size:13px;">
            Automated report generated by <b>${pipelineName}</b>
          </p>

          <table style="width:100%; font-size:13px; border-collapse:collapse;">
            <tr>
              <td style="padding:4px 0; width:120px;"><b>Suite:</b></td>
              <td>${suite}</td>
            </tr>

            <tr>
              <td style="padding:4px 0;"><b>Status:</b></td>
              <td style="color:${testStatus === "Passed" ? "#0c7b16" : "#c62828"}">
                ${testStatus}
              </td>
            </tr>

            <tr>
              <td style="padding:4px 0;"><b>Duration:</b></td>
              <td>${duration}s</td>
            </tr>

            <tr>
              <td style="padding:4px 0;"><b>Timestamp:</b></td>
              <td>${new Date().toLocaleString()}</td>
            </tr>
          </table>

          ${
            reportUrl
              ? `
            <p style="margin-top:12px;">
              <a href="${reportUrl}" target="_blank"
                 style="background:#1976d2;color:#fff;padding:10px 14px;border-radius:6px;text-decoration:none;">
                View Full HTML Report
              </a>
            </p>`
              : ""
          }

          <p style="margin-top:10px; font-size:12px;">
            The detailed Playwright HTML report is attached below (if available).
          </p>
        </div>
      </div>
    `;

    // --- configure mail ---
    const transporter = nodemailer.createTransport({
      service: "gmail",
      auth: { user, pass },
    });

    const mailOptions = {
      from: `"Playwright CI" <${user}>`,
      to: ["gopalakrishnan93843@gmail.com", "gokulcoal78752@gmail.com"],
      cc: ["gokulgokul78752@gmail.com"],
      bcc: ["gokulakrishnan1607@gmail.com"],
      subject: `Playwright Report ‚Ä¢ ${suite} ‚Ä¢ ${testStatus}`,
      html: emailBody,
      attachments: [],
    };

    // attach report
    if (reportExists) {
      mailOptions.attachments.push({
        filename: "playwright-report.html",
        path: reportPath,
        contentType: "text/html",
      });
    } else {
      const fallback = path.resolve("playwright-report/index.html");
      if (fs.existsSync(fallback)) {
        mailOptions.attachments.push({
          filename: "playwright-report.html",
          path: fallback,
          contentType: "text/html",
        });
      }
    }

    // --- send ---
    const info = await transporter.sendMail(mailOptions);
    console.log("üì® Email sent:", info.messageId || "(no messageId)");
    process.exit(0);
  } catch (err) {
    console.error("‚ùå send_report.js failed:", err);
    process.exit(1);
  }
})();
