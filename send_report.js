import nodemailer from "nodemailer";
import fs from "fs";
import path from "path";

const user = process.env.GMAIL_USER;
const pass = process.env.GMAIL_PASS;

const suite = process.env.TEST_SUITE || "all";
const testStatus = process.env.TEST_STATUS || "Failed";
const reportUrl = process.env.REPORT_URL || null;

const pipelineName = process.env.PIPELINE_NAME || "QA Automation Pipeline";
const duration = process.env.TEST_DURATION || "-";

// AUTO-DETECT index.html OR report.html
function findHtmlReport() {
  function search(dir) {
    const list = fs.readdirSync(dir, { withFileTypes: true });

    for (const file of list) {
      const full = path.join(dir, file.name);

      if (file.isDirectory()) {
        const found = search(full);
        if (found) return found;
      }

      if (file.isFile() && (file.name === "index.html" || file.name === "report.html")) {
        return full;
      }
    }
    return null;
  }

  return search("playwright-report");
}

const reportPath = findHtmlReport();
const reportExists = !!reportPath;

if (reportExists) {
  console.log("‚úÖ Found HTML report:", reportPath);
} else {
  console.warn("‚ö†Ô∏è No HTML report found inside playwright-report");
}

const transporter = nodemailer.createTransport({
  service: "gmail",
  auth: { user, pass },
});

// EMAIL BODY
let emailBody = `
<div style="font-family:Arial; background:#eef3fc; padding:14px;">
  <div style="background:#fff; padding:14px; border-radius:6px; border:1px solid #c5d3f2; max-width:550px;">
    
    <h2 style="margin:0 0 10px 0;">Playwright CI Test Report</h2>

    ${reportUrl ? `
    <p>
      <a href="${reportUrl}" target="_blank"
        style="background:#1976d2; color:#fff; padding:10px 14px; border-radius:6px;
               text-decoration:none; font-weight:bold;">
        View Full HTML Report
      </a>
    </p>` : ""}

    <p style="font-size:12px;">Automated report generated by <b>${pipelineName}</b></p>

    <table style="font-size:12px; width:100%;">
      <tr><td><b>Suite:</b></td><td>${suite}</td></tr>
      <tr><td><b>Status:</b></td>
          <td style="color:${testStatus === "Passed" ? "#0c7b16" : "#c62828"};">
            ${testStatus}
          </td></tr>
      <tr><td><b>Duration:</b></td><td>${duration}</td></tr>
      <tr><td><b>Timestamp:</b></td><td>${new Date().toLocaleString()}</td></tr>
    </table>

    <p style="margin-top:10px; font-size:12px;">
      The detailed Playwright HTML report is attached below.
    </p>

  </div>
</div>
`;

const mailOptions = {
  from: `"Playwright CI" <${user}>`,
  to: ["gopalakrishnan93843@gmail.com", "gokulcoal78752@gmail.com"],
  cc: ["gokulgokul78752@gmail.com"],
  bcc: ["gokulakrishnan1607@gmail.com"],
  subject: `Playwright Report ‚Ä¢ ${suite} ‚Ä¢ ${testStatus}`,
  html: emailBody,
};

if (reportExists) {
  mailOptions.attachments = [
    {
      filename: "playwright-report.html",
      path: reportPath,
      contentType: "text/html",
    },
  ];
}

try {
  await transporter.sendMail(mailOptions);
  console.log("üì® Email sent successfully!");
} catch (err) {
  console.error("‚ùå Failed to send email:", err.message);
  process.exit(1);
}
