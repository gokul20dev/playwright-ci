import nodemailer from "nodemailer";
import fs from "fs";
import path from "path";

// Gmail credentials
const user = process.env.GMAIL_USER;
const pass = process.env.GMAIL_PASS;

// Suite + status
const suite = process.env.TEST_SUITE || "all";
const testStatus = process.env.TEST_STATUS || "Failed";

// S3 / report paths
const reportPath = path.resolve("playwright-report/index.html");
const reportUrl = process.env.REPORT_URL || null;

// Other metadata
const pipelineName = process.env.PIPELINE_NAME || "QA Automation Pipeline";
const duration = process.env.TEST_DURATION || "-";

// ------------------------------------------------------------------
// üìä STEP 1 ‚Äî Correct Playwright test parsing (NEW FIXED VERSION)
// ------------------------------------------------------------------
const resultsJsonPath = "playwright-report/results.json";

let passed = 0;
let failed = 0;
let total = 0;

function walk(obj) {
  if (!obj) return;

  // If object contains tests array
  if (obj.tests && Array.isArray(obj.tests)) {
    obj.tests.forEach(test => {
      total++;

      let hasFailure = test.results.some(r => r.status !== "passed");
      if (hasFailure) failed++;
      else passed++;
    });
  }

  // Recursively walk deeper
  if (obj.suites) obj.suites.forEach(walk);
  if (obj.specs) obj.specs.forEach(walk);
}

try {
  const raw = fs.readFileSync(resultsJsonPath, "utf8");
  const json = JSON.parse(raw);

  walk(json);

  console.log("üìä Accurate Test Summary:", { passed, failed, total });

} catch (err) {
  console.error("‚ö†Ô∏è Could not read results.json:", err.message);
}

// ------------------------------------------------------------------
// üìÅ STEP 2 ‚Äî Check if HTML report exists
// ------------------------------------------------------------------
let reportExists = false;
try {
  await fs.promises.access(reportPath);
  reportExists = true;
  console.log("‚úÖ Found Playwright HTML report:", reportPath);
} catch {
  console.warn("‚ö†Ô∏è Report not found:", reportPath);
}

// ------------------------------------------------------------------
// ‚úâÔ∏è STEP 3 ‚Äî SMTP Config
// ------------------------------------------------------------------
const transporter = nodemailer.createTransport({
  service: "gmail",
  auth: { user, pass },
});

// ------------------------------------------------------------------
// ‚ú® STEP 4 ‚Äî Email Body
// ------------------------------------------------------------------
let emailBody = `
<div style="font-family:Arial; background:#eef3fc; padding:14px;">
  <div style="background:#fff; padding:14px; border-radius:6px; border:1px solid #c5d3f2; max-width:550px;">
    
    <h2 style="margin:0 0 10px 0;">Playwright CI Test Report</h2>

    ${reportUrl ? `
    <p>
      <a href="${reportUrl}" target="_blank"
        style="background:#1976d2; color:#fff; padding:10px 14px; border-radius:6px;
               text-decoration:none; font-weight:bold;">
        View Full HML Report
      </a>
    </p>` : ""}

    <p style="font-size:12px;">Automated report generated by <b>${pipelineName}</b></p>

    <table style="font-size:12px; width:100%;">
      <tr><td><b>Suite:</b></td><td>${suite}</td></tr>
      <tr><td><b>Status:</b></td>
          <td style="color:${testStatus === "Passed" ? "#0c7b16" : "#c62828"};">${testStatus}</td></tr>
      <tr><td><b>Duration:</b></td><td>${duration}</td></tr>
      <tr><td><b>Timestamp:</b></td><td>${new Date().toLocaleString()}</td></tr>
    </table>

    <h3>Test Summary</h3>
    <ul style="font-size:12px;">
      <li>‚úÖ Passed: <b>${passed}</b></li>
      <li>‚ùå Failed: <b>${failed}</b></li>
      <li>üì¶ Total: <b>${total}</b></li>
    </ul>
`;

if (reportExists) {
  emailBody += `
    <div style="margin-top:10px; background:#eaf2ff; padding:10px; border-left:4px solid #1976d2;">
      The Playwright HTML report is attached below for offline viewing.
    </div>`;
}

emailBody += `
    <p style="font-size:11px; color:#777;">Sent automatically by <b>Playwright CI</b>.</p>
  </div>
</div>
`;

// ------------------------------------------------------------------
// üìÆ STEP 5 ‚Äî Mail options
// ------------------------------------------------------------------
const mailOptions = {
  from: `"Playwright CI" <${user}>`,
  to: ["gopalakrishnan93843@gmail.com", "gokulcoal78752@gmail.com"],
  cc: ["gokulgokul78752@gmail.com"],
  bcc: ["gokulakrishnan1607@gmail.com"],
  subject: `Playwright Report ‚Ä¢ ${suite} ‚Ä¢ ${testStatus}`,
  html: emailBody,
};

if (reportExists) {
  mailOptions.attachments = [
    {
      filename: "playwright-report.html",
      path: reportPath,
      contentType: "text/html",
    },
  ];
}

// ------------------------------------------------------------------
// üöÄ STEP 6 ‚Äî Send email
// ------------------------------------------------------------------
try {
  await transporter.sendMail(mailOptions);
  console.log("üì® Email sent successfully with accurate counts!");
} catch (err) {
  console.error("‚ùå Failed to send email:", err.message);
  process.exit(1);
}
