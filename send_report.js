import nodemailer from "nodemailer";
import fs from "fs";
import path from "path";

// Gmail credentials
const user = process.env.GMAIL_USER;
const pass = process.env.GMAIL_PASS;

// Suite + status
const suite = process.env.TEST_SUITE || "all";
const testStatus = process.env.TEST_STATUS || "Failed";

// S3 + report paths
const reportPath = path.resolve("playwright-report/index.html");
const reportUrl = process.env.REPORT_URL || null;

// Other metadata
const pipelineName = process.env.PIPELINE_NAME || "QA Automation Pipeline";
const duration = process.env.TEST_DURATION || "-";

// ---------------------------------------------------------------
// üìä STEP 1 ‚Äî Extract REAL test results from Playwright JSON
// ---------------------------------------------------------------

// [UPDATED PATH] ‚Äì JSON file is inside playwright-report/
const resultsJsonPath = path.resolve("playwright-report/results.json");

// Default values
let passed = 0;
let failed = 0;
let skipped = 0;
let total = 0;

try {
  const resultsRaw = fs.readFileSync(resultsJsonPath, "utf8");
  const results = JSON.parse(resultsRaw);

  // Stats are available directly
  passed = results?.stats?.expected ?? 0;
  failed = results?.stats?.unexpected ?? 0;
  skipped = results?.stats?.skipped ?? 0;
  total = results?.stats?.total ?? passed + failed;

  console.log("üìä Test Summary:", { passed, failed, skipped, total });

} catch (err) {
  console.error("‚ö†Ô∏è Could not read JSON results:", err.message);
}

// ---------------------------------------------------------------
// üìÅ STEP 2 ‚Äî Check if HTML report exists
// ---------------------------------------------------------------
let reportExists = false;
try {
  await fs.promises.access(reportPath);
  reportExists = true;
  console.log("‚úÖ Found Playwright HTML report:", reportPath);
} catch {
  console.warn("‚ö†Ô∏è Report not found at:", reportPath);
}

// ---------------------------------------------------------------
// ‚úâÔ∏è STEP 3 ‚Äî Configure Gmail SMTP
// ---------------------------------------------------------------
const transporter = nodemailer.createTransport({
  service: "gmail",
  auth: { user, pass },
});

// ---------------------------------------------------------------
// üé® STEP 4 ‚Äî Build Email Body with NEW Test Summary Box
// ---------------------------------------------------------------
let emailBody = `
  <div style="font-family: Arial; color:#222; background:#eef3fc; padding:14px;">
    <div style="background:#fff; border-radius:6px; padding:14px; border:1px solid #c5d3f2; max-width:520px;">

      <h2 style="color:#000; margin:0 0 10px 0; font-size:20px; font-weight:700;">
        Playwright CI Test Report
      </h2>

      ${reportUrl ? `
        <p style="margin:10px 0 18px 0;">
          <a href="${reportUrl}" target="_blank"
             style="display:inline-block;background:#1976d2;color:#fff;
                    padding:10px 14px;font-weight:bold;border-radius:6px;
                    text-decoration:none;font-size:13px;">
            View Full HTML Report
          </a>
        </p>
      ` : ""}

      <p style="margin:0 0 12px 0; font-size:12px; color:#555;">
        Automated report generated by <b>${pipelineName}</b>
      </p>

      <table style="width:100%; font-size:12px; border-collapse:collapse;">

        <tr>
          <td style="width:120px; padding:4px 0;"><b>Suite:</b></td>
          <td>${suite}</td>
        </tr>

        <tr>
          <td style="padding:4px 0;"><b>Status:</b></td>
          <td style="color:${testStatus === "Passed" ? "#0c7b16" : "#c62828"};">
            ${testStatus}
          </td>
        </tr>

        <tr>
          <td style="padding:4px 0;"><b>Duration:</b></td>
          <td>${duration}</td>
        </tr>

        <tr>
          <td style="padding:4px 0;"><b>Timestamp:</b></td>
          <td>${new Date().toLocaleString()}</td>
        </tr>

      </table>

      <!-- ========================================================= -->
      <!-- [ADDED] üìä TEST SUMMARY BOX -->
      <!-- ========================================================= -->
      <div style="
        margin-top:14px;
        background:#f4f6ff;
        padding:10px 12px;
        border-left:4px solid #1976d2;
        font-size:13px;
        border-radius:4px;
      ">
        <b style="font-size:14px;">üìä Test Summary</b>
        <div style="margin-top:6px; line-height:1.5;">
          ‚úî <b style="color:#0c7b16;">Passed:</b> ${passed}<br>
          ‚ùå <b style="color:#c62828;">Failed:</b> ${failed}<br>
          ‚ûñ <b style="color:#444;">Skipped:</b> ${skipped}<br>
          üì¶ <b>Total:</b> ${total}
        </div>
      </div>
      <!-- ========================================================= -->
`;

// Attachment note
if (reportExists) {
  emailBody += `
      <div style="margin-top:12px; background:#eaf2ff; padding:10px;
                  border-left:4px solid #1976d2; font-size:12px;">
        The Playwright HTML report is attached below for offline viewing.
      </div>
  `;
}

// Footer
emailBody += `
      <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">
      <p style="font-size:11px;color:#777;">
        Sent automatically by <b>Playwright CI</b> ‚Äî do not reply to this email.
      </p>
    </div>
  </div>
`;

// ---------------------------------------------------------------
// üìÆ STEP 5 ‚Äî Compose mail options
// ---------------------------------------------------------------
const mailOptions = {
  from: `"Playwright CI" <${user}>`,
  to: ["gopalakrishnan93843@gmail.com", "gokulcoal78752@gmail.com"],
  cc: ["gokulgokul78752@gmail.com"],
  bcc: ["gokulakrishnan1607@gmail.com"],
  subject: `Playwright Report ‚Ä¢ ${suite} ‚Ä¢ ${testStatus}`,
  html: emailBody,
};

// Attach report file
if (reportExists) {
  mailOptions.attachments = [
    {
      filename: "playwright-report.html",
      path: reportPath,
      contentType: "text/html",
    },
  ];
}

// ---------------------------------------------------------------
// üöÄ STEP 6 ‚Äî Send email
// ---------------------------------------------------------------
try {
  await transporter.sendMail(mailOptions);
  console.log("üì® Email sent successfully with correct stats!");
} catch (err) {
  console.error("‚ùå Failed to send email:", err.message);
  process.exit(1);
}
